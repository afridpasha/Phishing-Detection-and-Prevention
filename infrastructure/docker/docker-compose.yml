version: '3.9'
services:

  # ─── DATABASES ───────────────────────────────────────────────
  postgres:
    image: timescale/timescaledb:latest-pg16
    environment:
      POSTGRES_USER: phishing_shield
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-changeme}
      POSTGRES_DB: phishing_shield_db
    ports: ['5432:5432']
    volumes: ['postgres_data:/var/lib/postgresql/data']

  redis:
    image: redis:7.2-alpine
    command: redis-server --requirepass ${REDIS_PASSWORD:-changeme}
    ports: ['6379:6379']

  neo4j:
    image: neo4j:5.18
    environment:
      NEO4J_AUTH: neo4j/${NEO4J_PASSWORD:-changeme}
      NEO4J_PLUGINS: '["apoc", "graph-data-science"]'
    ports: ['7474:7474', '7687:7687']
    volumes: ['neo4j_data:/data']

  minio:
    image: minio/minio:latest
    command: server /data --console-address ':9001'
    environment:
      MINIO_ROOT_USER: ${MINIO_ACCESS_KEY:-minioadmin}
      MINIO_ROOT_PASSWORD: ${MINIO_SECRET_KEY:-changeme}
    ports: ['9000:9000', '9001:9001']

  elasticsearch:
    image: elasticsearch:8.12.0
    environment:
      - discovery.type=single-node
      - xpack.security.enabled=false
    ports: ['9200:9200']

  # ─── STREAMING ────────────────────────────────────────────────
  zookeeper:
    image: confluentinc/cp-zookeeper:7.6.0
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181

  kafka:
    image: confluentinc/cp-kafka:7.6.0
    depends_on: [zookeeper]
    ports: ['9092:9092']
    environment:
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://localhost:9092
      KAFKA_AUTO_CREATE_TOPICS_ENABLE: 'true'
      KAFKA_NUM_PARTITIONS: 12

  # ─── ML INFRASTRUCTURE ────────────────────────────────────────
  mlflow:
    image: ghcr.io/mlflow/mlflow:v2.11.0
    command: mlflow server --host 0.0.0.0 --port 5000
    ports: ['5000:5000']

  # ─── API GATEWAY ──────────────────────────────────────────────
  api-gateway:
    build:
      context: .
      dockerfile: infrastructure/docker/Dockerfile.api
    ports: ['8000:8000']
    env_file: .env
    depends_on: [postgres, redis, neo4j, kafka]
    volumes: ['./models:/app/models:ro']

volumes:
  postgres_data:
  neo4j_data:
